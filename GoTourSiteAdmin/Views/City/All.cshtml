
@{
    ViewData["Title"] = "All";
}

<!--navbar-->
@{
    await Html.RenderPartialAsync("_Navbar");
}
<!--end navbar-->
<div class="wrapper">
    <!--sidebar-->
    @{
        await Html.RenderPartialAsync("_Sidebar");
    }
    <!--end sidebar-->
    <!--page wrapper-->
    <main class="container-fluid">

        <div class="container-fuid pt-2 pb-4">
            <div class="p-md-4">
                <div class="form-custom rounded-normal bg-purple-dark py-4 p-4 px-md-5 px-3">
                    <a asp-controller="City" asp-action="Add" class="btn btn-sm btn-orange my-2">Nueva ciudad</a>
                    @Html.Partial("_TableCity")

                </div>
            </div>

        </div>
    </main>
    <!--end page wrapper-->
</div>
@section scripts {
    <script>

        $(document).ready(function () {

            $('#TableCity').DataTable({
                "language": {
                    "url": "/lib/datatables/spanish.json"
                },
                "ajax": {
                    "url": "@Url.Action("GetData", "City")",
                    "type": "GET",
                    "async":"true",
                    "datatype": "json"
                },
                "columns": [
                    { "data": 'name' },
                    { "data": 'temperature' },                  
                    { "data": 'altitude' },
                    { "data": 'population' },
                    {
                        "data": 'urlPhoto',
                        "render": function (data) {
                            return '<img class="img-fluid" width="70" src="' + data + '" alt="Alternate Text" />';
                        }
                    },
                    {
                        "data": "state",
                        "render": function (data, type, full) {
                            if (data == 1) {
                                return '<span class="badge badge-success">Activo</span>';
                            }
                            else {
                                return '<span class="badge badge-danger">Inactivo</span>';
                            }
                        }
                    },
                    {
                        "targets": 6,
                        "data": 'id',
                        "render": function (data, type, full) {
                            var editButton = '<button class="btn btn-primary btn-sm" onclick="EditCity(this.id)" id=' + data + '><i class="fas fa-edit"></i></button>';
                            if (full["state"] == 1) {
                                return editButton + '<button onclick="ChangeState(this.id, '+ full["state"]+')" id=' + full["id"] +' type="button" class="btn btn-sm btn-danger mb-2"><i class="fas fa-minus-circle"></i></button>';
                            }
                            else {
                                return '<button  onclick="ChangeState(this.id,'+ full["state"] +')" id='+ full["id"] +' type="button" class="btn btn-sm btn-success mb-2"><i class="fas fa-plus-circle"></i></button>';
                            }
                        }

                    },
                     {
                        "targets": 7,
                        "data": 'id',
                         "render": function (data, type, full) {
                             if (full["state"] == 1) {
                                 return '<button class="btn btn-primary btn-sm" onclick="Details(this.id)" id=' + data + '><i class="fas fa-info-circle"></i></button>';
                             }
                             return null;
                        }

                    }
                ],
                //rowCallback: function (row, data, index) {
                //    if (data.state == 1) {
                //        $("#h").addClass("bg-primary");
                //    }
                //}

            });
        });
        function EditCity(Id) {
            $.ajax({
                type: "POST",
                url: "/City/GetDataById",
                Datatype: 'json',
                async: true,
                data: { valId: Id },
                success: function (response) {
                    if (response.content == "True") {
                        window.location.href = '@Url.Action("Edit", "City")';
                    } else if (response.content == "False") {
                        window.location.href = '@Url.Action("Error", "Home")';
                    }

                },
                error: function (xhr) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }

            });
        }

        function ChangeState(Id, State) {

            var Id = Id;
            var State= State;
            $.ajax({
                url: "/City/ChangeState",
                type: "POST",
                data: { valId: Id , valState:State},
                DataType: "json",
                async: true,
                success: function (response) {
                    if (response.content == "1" && response.state == "1") {
                        Swal.fire(
                            'Ciudad Desactivada',
                            '',
                            'success'
                        ).then(function () {
                            $('#TableCity').DataTable().ajax.reload();
                        });
                    }
                    else if (response.content == "1" && response.state == "2") {
                        Swal.fire(
                            'Ciudad Activada',
                            '',
                            'success'
                        ).then(function () {
                            $('#TableCity').DataTable().ajax.reload();
                        });
                    }
                    else if (response.content == "3" || response.content =="4") {
                           Swal.fire(
                            'No se puedo actualizar el estado de la ciudad',
                            '',
                            'error'
                        )
                    }
                },
                error: function (xhr) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }

            });
        }
        function Details(Id) {
             $.ajax({
                type: "POST",
                url: "/UserPortal/GetDataUserPortal",
                Datatype: 'json',
                async: true,
                data: { valId: Id},
                success: function (response) {
                    if (response.content == "True") {
                        window.location.href = '@Url.Action("Detail", "UserPortal")';
                    } else if (response.content == "False") {
                        window.location.href = '@Url.Action("Error", "Home")';
                    }

                },
                error: function (xhr) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }

            });
        }
    </script>}

