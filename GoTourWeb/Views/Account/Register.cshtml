@using GoTourWeb.Helpers
@{
    ViewData["Title"] = "Register";
    string vLanguage = ViewData["LanguageInitialDefault"].ToString();

}

<div id="register-div" class="container-fluid p-0 account-page register">
    <div class="icon-back">
        @if (string.IsNullOrEmpty(Startup._vReturnUrl)) {
            <a asp-area="" asp-controller="Home" asp-action="Index"><i style="" class="fas fa-caret-left"></i></a>
        } 

    </div>
    <div style="min-height: calc(100vh - 46px);" class="container">
        <div class="row align-items-center justify-content-center">
            <div class="col-12 col-sm-8 col-md-5 px-5 py-3">
                <!-- logo -->
                <div class="py-4 text-center">
                    <a asp-area="" asp-controller="Home" asp-action="Index"><img class=" img-fluid" src="~/images/logoregistro.svg" width="220" alt=""></a>
                </div>
                <!-- end logo -->
                <!-- social buttons -->
                <div class="row">
                    <div class="col-md-6 py-2 py-md-0">
                        @*<i class="mr-2 fab fa-google"></i> <span>@Language.GetTextView("Register", "account_button_1", vLanguage)</span>*@
                        <div class="g-signin2" onclick="siginGoogle()" data-onsuccess="onSignIn"></div>
                    </div>
                    <div class="col-md-6 py-2 py-md-0">
                        <button class="btn btn-blue btn-block" id="btnFBLogin">
                        <i class="mr-2 fab fa-facebook-f"></i> <span>@Language.GetTextView("Register", "account_button_2", vLanguage)</span>
                        </button>
                        <fb:login-button id="btnFBDefault" style="display:none;" scope="public_profile,email" onlogin="checkLoginState();">
                        </fb:login-button>
                    </div>
                </div>

                <span class="lineon py-3">o</span>
                <!-- end social buttons -->
                <!-- form -->

                <form method="POST">
                    <div class="form-row">
                        <div class="col-md-6">
                            <div class="form-group container-input">
                                <i class="fas fa-user" data-fa-transform="grow-2"></i>
                                <input id="FirstName" name="FirstName" class="form-control" placeholder="@Language.GetTextView("Register", "input_name", vLanguage)" type="text" maxlength="30">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group container-input">
                                <i class="fas fa-user-shield" data-fa-transform="grow-2"></i>
                                <input id="FirstLastName" name="FirstLastName" class="form-control" placeholder="@Language.GetTextView("Register", "input_surname", vLanguage)" type="text" maxlength="30">
                            </div>

                        </div>

                    </div>
                    <div class="form-group container-input">
                        <i class="fas fa-envelope" data-fa-transform="grow-2"></i>
                        <input id="Email" name="Email" class="form-control" placeholder="@Language.GetTextView("Register", "input_email", vLanguage)" type="email" maxlength="30">

                    </div>
                    <div class="form-group container-input">
                        <i class="fas fa-lock" data-fa-transform="grow-2"></i>
                        <input id="Password" name="Password" class="form-control" placeholder="@Language.GetTextView("Register", "input_password", vLanguage)" type="password" maxlength="10">

                    </div>
                    <div id="ErrorAlert"></div>
                    <button id="ButtonRegister" type="button" class="my-3 btn btn-orange btn-block">@Language.GetTextView("Register", "register_button", vLanguage)</button>
                    <p class="py-3 text-center">
                        @Language.GetTextView("Register", "question_register", vLanguage)
                        @if (string.IsNullOrEmpty(Startup._vReturnUrl)) {
                              <a asp-area="" asp-controller="Account" asp-action="Login">@Language.GetTextView("Register", "signin_link", vLanguage)</a>
                        } else {
                             <a href="@Url.Action("Login", "Account", new { vReturnUrl = "pay"})">@Language.GetTextView("Register", "signin_link", vLanguage)</a>
                        }

                                    </p>
                </form>
                <!-- /form -->
            </div>

        </div>
    </div>
    <!-- footer -->
    <footer class="bg-purple">
        <div class="footer-copy py-3">
            <p class="m-0 text-center">© 2018 <a href="#">Go Tours</a>&nbsp;@Language.GetTextView("Index", "copyright", vLanguage) </p>
        </div>
    </footer>
    <!-- footer -->
</div>


<script>
    function validateFields() {
        if ($('#FirstName').val() == "" && $('#FirstLastName').val() == ""
            && $('#Email').val() == "" && $('#Password').val() == "") {
            $("#ErrorAlert").html("<div class='alert alert-danger alert-dismissible fade show' role='alert'><strong><i class='fas fa-exclamation-circle'></i></strong> @Language.GetTextView("Register", "error_alert_1", vLanguage) <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button></div>");
            return false;
        }
        if ($('#FirstName').val() == "") {
            $("#ErrorAlert").html("<div class='alert alert-danger alert-dismissible fade show' role='alert'><strong><i class='fas fa-exclamation-circle'></i></strong> @Language.GetTextView("Register", "error_alert_2", vLanguage) <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button></div>");
            return false;
        }
        if ($('#FirstLastName').val() == "") {
            $("#ErrorAlert").html("<div class='alert alert-danger alert-dismissible fade show' role='alert'><strong><i class='fas fa-exclamation-circle'></i></strong> @Language.GetTextView("Register", "error_alert_3", vLanguage) <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button></div>");
            return false;
        }
        if ($('#Email').val() == "") {
            $("#ErrorAlert").html("<div class='alert alert-danger alert-dismissible fade show' role='alert'><strong><i class='fas fa-exclamation-circle'></i></strong> @Language.GetTextView("Register", "error_alert_4", vLanguage) <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button></div>");
            return false;
        }
        if ($('#Password').val() == "") {
            $("#ErrorAlert").html("<div class='alert alert-danger alert-dismissible fade show' role='alert'><strong><i class='fas fa-exclamation-circle'></i></strong> @Language.GetTextView("Register", "error_alert_5", vLanguage) <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button></div>");
            return false;
        }
   
     
        return true;
    }

    $("#FirstName,#FirstLastName,#Email,#Password").keyup(function (event) {
        if (event.keyCode === 13) {
            if (validateFields()) {
                $("#ButtonRegister").click();
            }
           
        }
    });

    function validatefieldscontact() {
        emailRegex = /^[-\w.%+]{1,64}@@(?:[A-Z0-9-]{1,63}\.){1,125}[A-Z]{2,63}$/i;
        if (!emailRegex.test($('#Email').val().trim())) {
            $("#ErrorAlert").html("<div class='alert alert-danger alert-dismissible fade show' role='alert'><strong><i class='fas fa-exclamation-circle'></i></strong> @Language.GetTextView("Register", "error_alert_6", vLanguage) <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button></div>");

            return false;
        }
        onlyletters = /^[a-zA-Z ]+$/;
        if ($('#FirstName').val().length < 3 || !onlyletters.test($('#FirstName').val().trim())) {
            $('#ErrorAlert').html("<div class='alert alert-danger alert-dismissible fade show' role='alert'><strong><i class='fas fa-exclamation-circle'></i></strong> @Language.GetTextView("Register", "error_alert_7", vLanguage) <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button></div>");
            return false;
        }
        if ($('#FirstLastName').val().length < 3 || !onlyletters.test($('#FirstLastName').val().trim())) {
            $('#ErrorAlert').html("<div class='alert alert-danger alert-dismissible fade show' role='alert'><strong><i class='fas fa-exclamation-circle'></i></strong> @Language.GetTextView("Register", "error_alert_8", vLanguage)<button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button></div>");
            return false;
        }
        if ($('#Password').val().length < 8) {
            $('#ErrorAlert').html("<div class='alert alert-danger alert-dismissible fade show' role='alert'><strong><i class='fas fa-exclamation-circle'></i></strong> @Language.GetTextView("Register", "error_alert_9", vLanguage) <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button></div>");
            return false;
        }
        passwordN = /^[0-9]+$/;
        
        if(passwordN.test($('#Password').val().trim())) {
            $('#ErrorAlert').html("<div class='alert alert-danger alert-dismissible fade show' role='alert'><strong><i class='fas fa-exclamation-circle'></i></strong> @Language.GetTextView("Register", "error_alert_10", vLanguage) <button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button></div>");
            return false;
        }
        
        return true;
    }
    $("#Email").keyup(function (event) {
        if (event.keyCode === 13) {
            if (validatefieldscontact()) {
                $("#buttonLogin").click();
            }
        }
    });
    $(function() {
        $("#ButtonRegister").click(function () {
               
                if (!validateFields()) {
                    return false;
                 }
                if (!validatefieldscontact()) {
                    return false;
                 }
                $("#ErrorAlert").html("");
                var model = {
                    FirstName: $.trim($('#FirstName').val()),
                    FirstLastName: $.trim($('#FirstLastName').val()),
                    Password: $.trim($('#Password').val()),
                    Email: $.trim($('#Email').val())
                    
                };
             
                    $.ajax({
                        url: "/Account/Register",
                        method: "POST",
                        data: JSON.stringify(model),
                        dataType: "JSON",
                        contentType: 'application/json',
                        async: true,
                        success: function (response) {
                            if (response.content == "1") {
                                Swal({
                                    type: 'success',
                                    title: '@Language.GetMessageIn("Register", "1", vLanguage, "Title")',
                                    text: '@Language.GetMessageIn("Register", "1", vLanguage, "Text")'
                                }).then(function () {
                                   
                                    window.location = '@Url.Action("Login", "Account")';
                                    
                                 });
                            } else if (response.content == "5") {
                                Swal({
                                    type: 'success',
                                    title: '@Language.GetMessageIn("Register", "1", vLanguage, "Title")',
                                    text: '@Language.GetMessageIn("Register", "1", vLanguage, "Text")'
                                }).then(function () {
                                    window.location = '@Url.Action("Login", "Account", new { vReturnUrl = "pay" })';
                                    
                                 });
                            }else if (response.content == "2" || response.content == "4") {
                                Swal({
                                    type: 'error',
                                    title: '@Language.GetMessageIn("Register", "2", vLanguage, "Title")',
                                    text: '@Language.GetMessageIn("Register", "2", vLanguage, "Text")'
                                });
                            } else if (response.content == "3") {
                                Swal({
                                    type: 'warning',
                                    title: '@Language.GetMessageIn("Register", "3", vLanguage, "Title")',
                                    text: '@Language.GetMessageIn("Register", "3", vLanguage, "Text")'
                                });
                            } 
                            
                            
                        },
                        beforeSend: function () {
                            $("body").fadeIn(function () {
                                $(".modaldisplay").show();
                            });
                        },
                        complete: function () {
                            $(".modaldisplay").hide();
                        },
                        error: function (xhr) {
                            console.log(xhr.status + ": " + xhr.responseText);
                        }
                    });
            })
    })

    var clicked = false;

    function siginGoogle() {
        clicked = true;
    }

    function onSignIn(googleUser) {
        if (clicked) {
            var profile = googleUser.getBasicProfile();
       
        var model = {
            FirstName: profile.getGivenName(),
            FirstLastName: profile.getFamilyName(),
            Password: '1234abcd',
            Email: profile.getEmail(),
            UrlPhoto: profile.getImageUrl()
        };

        $.ajax({
            url: "/Account/RegisterByExternalLogin",
            method: "POST",
            data: JSON.stringify(model),
            dataType: "JSON",
            contentType: 'application/json',
            async: true,
            success: function (response) {
                if (response.content == "1") {
                    window.location = '@Url.Action("Index", "Home")';
                } else if (response.content == "2" || response.content == "4") {
                    Swal({
                        type: 'error',
                        title: '@Language.GetMessageIn("Register", "2", vLanguage, "Title")',
                        text: '@Language.GetMessageIn("Register", "2", vLanguage, "Text")'
                    });
                } else if (response.content == "3") {
                    $.ajax({
                        url: "/Account/LoginExternal",
                        method: "POST",
                        data: JSON.stringify(model),
                        dataType: "JSON",
                        contentType: 'application/json',
                        async: true,
                        success: function (response) {
                            if (response.content == "1") {
                                window.location = '@Url.Action("Index", "Home")';
                            }
                        }
                    });
                }
            },
            beforeSend: function () {
                $("body").fadeIn(function () {
                $(".modaldisplay").show();
                });
            },
            complete: function () {
                $(".modaldisplay").hide();
            },
            error: function (xhr) {
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });
        }
        clicked = false;     
    }

    

    function statusChangeCallback(response) {
        if (response.status === 'connected') {
                testAPI();
        } else {
            //console.log("Logueate in this app");
        }
    }

    function checkLoginState() {
        FB.getLoginStatus(function (response) {
            statusChangeCallback(response);
        });
    }
  
window.fbAsyncInit = function () {
  
        FB.init({
            appId: '347569362758334',
            cookie: true,  
            xfbml: true, 
            version: 'v3.2'
    });
    };

    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = 'https://connect.facebook.net/en_US/sdk.js';
        fjs.parentNode.insertBefore(js, fjs);
    }
    (document, 'script', 'facebook-jssdk'));

    function testAPI() {
        FB.api('/me', { "fields": "email,id,name,last_name,first_name,picture{url}" }, function (response) {
            var model = {
                FirstName: response.first_name,
                FirstLastName: response.last_name,
                Password: '1234abcd',
                Email: response.email,
                UrlPhoto: response.picture.data.url

            };

            $.ajax({
                url: "/Account/RegisterByExternalLogin",
                method: "POST",
                data: JSON.stringify(model),
                dataType: "JSON",
                contentType: 'application/json',
                async: true,
                success: function (response) {
                    if (response.content == "1") {
                        window.location = '@Url.Action("Index", "Home")';

                    } else if (response.content == "2" || response.content == "4") {
                        Swal({
                            type: 'error',
                            title: '@Language.GetMessageIn("Register", "2", vLanguage, "Title")',
                            text: '@Language.GetMessageIn("Register", "2", vLanguage, "Text")'
                        });
                    } else if (response.content == "3") {
                        $.ajax({
                            url: "/Account/LoginExternal",
                            method: "POST",
                            data: JSON.stringify(model),
                            dataType: "JSON",
                            contentType: 'application/json',
                            async: true,
                            success: function (response) {
                                if (response.content == "1") {
                                    window.location = '@Url.Action("Index", "Home")';
                                }
                            }
                        });
                    }
                },
                beforeSend: function () {
                    $("body").fadeIn(function () {
                        $(".modaldisplay").show();
                    });
                },
                complete: function () {
                    $(".modaldisplay").hide();
                },
                error: function (xhr) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }
            });  
        });
    }
    $("#btnFBLogin").click(function () {
        $("#btnFBDefault").trigger("click");
    });

</script>
